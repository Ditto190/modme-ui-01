name: Incremental Toolset Documentation

on:
  pull_request:
    paths:
      - 'agent/**/*.py'
      - 'src/**/*.{ts,tsx}'
      - 'scripts/**/*.{js,sh}'
  workflow_dispatch:

jobs:
  detect-changes:
    name: Detect Changed Toolsets
    runs-on: ubuntu-latest
    outputs:
      changed_toolsets: ${{ steps.detect.outputs.changed_toolsets }}
      has_changes: ${{ steps.detect.outputs.has_changes }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Install ripgrep
        run: |
          curl -LO https://github.com/BurntSushi/ripgrep/releases/download/14.1.1/ripgrep_14.1.1-1_amd64.deb
          sudo dpkg -i ripgrep_14.1.1-1_amd64.deb
      
      - name: Install jq
        run: sudo apt-get install -y jq
      
      - name: Detect changed toolsets
        id: detect
        run: |
          # Get changed files
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }})
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # Search for toolset references in changed files
          CHANGED_TOOLSETS=""
          for file in $CHANGED_FILES; do
            if [[ -f "$file" ]]; then
              # Search for toolset IDs (pattern: "ui_elements", "theme", etc.)
              TOOLSET_REFS=$(rg --json -o '"[a-z_]+"' "$file" 2>/dev/null | jq -r 'select(.type=="match") | .data.lines.text' || true)
              if [[ -n "$TOOLSET_REFS" ]]; then
                CHANGED_TOOLSETS="$CHANGED_TOOLSETS $TOOLSET_REFS"
              fi
            fi
          done
          
          # Remove duplicates
          CHANGED_TOOLSETS=$(echo "$CHANGED_TOOLSETS" | tr ' ' '\n' | sort -u | tr '\n' ' ')
          
          if [[ -n "$CHANGED_TOOLSETS" ]]; then
            echo "changed_toolsets=$CHANGED_TOOLSETS" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi
          
          echo "Changed toolsets: $CHANGED_TOOLSETS"
      
      - name: Comment on PR
        if: steps.detect.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `### ðŸ“š Toolset Changes Detected\n\nThe following toolsets may have been modified:\n\n${process.env.CHANGED_TOOLSETS.split(' ').map(t => `- \`${t}\``).join('\n')}\n\nDocumentation will be regenerated for these toolsets.`
            })
        env:
          CHANGED_TOOLSETS: ${{ steps.detect.outputs.changed_toolsets }}

  generate-docs:
    name: Generate Documentation
    needs: detect-changes
    runs-on: ubuntu-latest
    if: needs.detect-changes.outputs.has_changes == 'true'
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.9.0'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Generate documentation
        run: |
          node scripts/knowledge-management/sync-docs.js --direction json-to-md --verbose
          node scripts/knowledge-management/generate-diagram.js --format svg --verbose
      
      - name: Upload documentation
        uses: actions/upload-artifact@v4
        with:
          name: toolset-docs-${{ github.sha }}
          path: |
            docs/toolsets/*.md
            docs/toolsets/*.svg
          retention-days: 30

  validate-docs:
    name: Validate Documentation
    needs: generate-docs
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.9.0'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Download generated docs
        uses: actions/download-artifact@v4
        with:
          name: toolset-docs-${{ github.sha }}
          path: docs/toolsets/
      
      - name: Validate documentation
        run: node scripts/knowledge-management/sync-docs.js --validate-only --verbose
