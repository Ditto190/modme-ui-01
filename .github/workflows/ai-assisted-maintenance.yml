name: AI-Assisted Maintenance

on:
  schedule:
    # Run weekly on Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      task_type:
        description: 'Type of maintenance task'
        required: true
        type: choice
        options:
          - dependency-update
          - security-audit
          - code-quality-check
          - documentation-update

jobs:
  dependency-check:
    name: Check for Dependency Updates
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event.inputs.task_type == 'dependency-update'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.9.0'

      - name: Check for outdated npm packages
        id: npm-outdated
        run: |
          npm outdated --json > outdated.json || true
          if [ -s outdated.json ]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "### ðŸ“¦ Outdated NPM Packages" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat outdated.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "âœ… All npm packages are up to date" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Check Python dependencies
        working-directory: ./agent
        run: |
          pip install pip-audit
          echo "### ðŸ Python Dependency Status" >> "$GITHUB_STEP_SUMMARY"
          
          # Run pip-audit and capture output in JSON format
          pip-audit --format json --desc > pip-audit.json || true
          
          if [ -s pip-audit.json ]; then
            echo '```json' >> "$GITHUB_STEP_SUMMARY"
            cat pip-audit.json >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            
            # Check for critical vulnerabilities using jq for robust JSON parsing
            if command -v jq &> /dev/null && jq -e '.[] | select(.severity == "CRITICAL")' pip-audit.json > /dev/null 2>&1; then
              echo "âŒ Critical Python dependency vulnerabilities found. Failing job." >> "$GITHUB_STEP_SUMMARY"
              exit 1
            else
              echo "âœ… No critical Python dependency vulnerabilities found." >> "$GITHUB_STEP_SUMMARY"
            fi
          else
            echo "pip-audit did not produce output; results may be incomplete." >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload outdated packages report
        if: steps.npm-outdated.outputs.has_updates == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: outdated-packages
          path: outdated.json

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event.inputs.task_type == 'security-audit'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.9.0'

      - name: Run npm audit
        id: npm-audit
        run: |
          npm audit --json > npm-audit.json || true
          
          echo "### ðŸ”’ NPM Security Audit" >> $GITHUB_STEP_SUMMARY
          if [ -s npm-audit.json ]; then
            VULNERABILITIES=$(cat npm-audit.json | jq -r '.metadata.vulnerabilities | to_entries | map("\(.key): \(.value)") | join(", ")')
            if [ "$VULNERABILITIES" != ": 0" ] && [ "$VULNERABILITIES" != "" ]; then
              echo "âš ï¸ Found vulnerabilities: $VULNERABILITIES" >> $GITHUB_STEP_SUMMARY
              echo '```json' >> $GITHUB_STEP_SUMMARY
              cat npm-audit.json | jq '.vulnerabilities' >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… No vulnerabilities found" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Run Python security audit
        working-directory: ./agent
        run: |
          pip install safety
          echo "### ðŸ Python Security Audit" >> $GITHUB_STEP_SUMMARY
          safety check --json > safety-report.json || true
          if [ -s safety-report.json ]; then
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat safety-report.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-reports
          path: |
            npm-audit.json
            agent/safety-report.json

  code-quality-check:
    name: Code Quality Analysis
    runs-on: ubuntu-latest
    if: github.event.inputs.task_type == 'code-quality-check'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.9.0'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Run linting
        run: |
          echo "### ðŸ“‹ Code Quality Report" >> $GITHUB_STEP_SUMMARY
          npm run lint > lint-report.txt 2>&1 || true
          if [ -s lint-report.txt ]; then
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat lint-report.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check code complexity
        run: |
          npx eslint . --format json > eslint-report.json || true
          echo "Complexity analysis complete" >> $GITHUB_STEP_SUMMARY

  create-maintenance-issue:
    name: Create Maintenance Issue
    runs-on: ubuntu-latest
    needs: [dependency-check, security-audit]
    if: always() && (needs.dependency-check.result == 'success' || needs.security-audit.result == 'success')
    
    permissions:
      issues: write
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create or update maintenance issue
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            const title = `ðŸ¤– AI-Assisted Maintenance Report - ${date}`;
            
            const body = `
            # Automated Maintenance Report
            
            This issue was automatically created by the AI-assisted maintenance workflow.
            
            ## Summary
            - ðŸ“¦ Dependency check completed
            - ðŸ”’ Security audit completed
            
            ## Next Steps
            1. Review the workflow run artifacts for detailed reports
            2. Prioritize security vulnerabilities
            3. Update dependencies in a separate PR
            4. Run tests to ensure compatibility
            
            ## Resources
            - [Workflow Run](${context.payload.repository.html_url}/actions/runs/${context.runId})
            - [Security Best Practices](https://docs.github.com/en/code-security)
            
            ---
            *This issue was created automatically. To disable these reports, adjust the workflow schedule.*
            `;
            
            // Search for existing maintenance issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['maintenance', 'automated'],
              per_page: 1
            });
            
            if (issues.data.length > 0) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: `## Update - ${date}\n\nNew maintenance check completed. See [workflow run](${context.payload.repository.html_url}/actions/runs/${context.runId}) for details.`
              });
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['maintenance', 'automated', 'dependencies']
              });
            }
