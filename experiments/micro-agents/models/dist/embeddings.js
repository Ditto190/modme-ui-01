"use strict";var b=Object.create;var l=Object.defineProperty;var x=Object.getOwnPropertyDescriptor;var v=Object.getOwnPropertyNames;var w=Object.getPrototypeOf,y=Object.prototype.hasOwnProperty;var P=(s,e)=>{for(var t in e)l(s,t,{get:e[t],enumerable:!0})},u=(s,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of v(e))!y.call(s,n)&&n!==t&&l(s,n,{get:()=>e[n],enumerable:!(i=x(e,n))||i.enumerable});return s};var E=(s,e,t)=>(t=s!=null?b(w(s)):{},u(e||!s||!s.__esModule?l(t,"default",{value:s,enumerable:!0}):t,s)),M=s=>u(l({},"__esModule",{value:!0}),s);var R={};P(R,{MODELS:()=>c,UnifiedEmbeddingService:()=>a,adaptiveRetrieval:()=>C,embeddingService:()=>d,generateEmbedding:()=>$,searchCodeWithEmbedding:()=>I});module.exports=M(R);var p=require("@huggingface/transformers"),h=E(require("fs/promises"),1),g=require("./greptimedb_client");const c={minilm:{id:"minilm",name:"all-MiniLM-L6-v2",modelId:"Xenova/all-MiniLM-L6-v2",dimension:384,task:"feature-extraction",speed:"fast",memoryMB:80,useCase:"General semantic search, fast queries"},gemma3n:{id:"gemma3n",name:"Gemma3n-1B",modelId:"google/gemma-3n-1b",dimension:1024,task:"feature-extraction",speed:"medium",memoryMB:500,useCase:"Deep semantic understanding, complex queries"}};class a{static instance;extractors=new Map;cache=new Map;initPromises=new Map;constructor(){}static getInstance(){return a.instance||(a.instance=new a),a.instance}async initialize(e="minilm"){if(this.extractors.has(e))return;if(this.initPromises.has(e))return this.initPromises.get(e);const t=this.doInitialize(e);this.initPromises.set(e,t);try{await t}finally{this.initPromises.delete(e)}}async doInitialize(e){const t=c[e];if(!t)throw new Error(`Unknown model key: ${e}. Available: ${Object.keys(c).join(", ")}`);try{console.error(`Loading embedding model: ${t.name} (${t.modelId})...`);const i=await(0,p.pipeline)(t.task,t.modelId);this.extractors.set(e,i),console.error(`Model loaded successfully (${t.dimension}-dim, ~${t.memoryMB}MB)`)}catch(i){throw console.error(`Failed to load model ${t.name}:`,i),i}}async generateEmbedding(e,t="minilm"){const i=`${t}:${e}`;if(this.cache.has(i))return this.cache.get(i);this.extractors.has(t)||await this.initialize(t);const n=this.extractors.get(t);if(!n)throw new Error(`Model ${t} not initialized`);try{const r=await n(e,{pooling:"mean",normalize:!0}),o=Array.from(r.data);return this.cache.set(i,o),o}catch(r){throw console.error(`Failed to generate embedding with ${t}:`,r),r}}async generateBatchEmbeddings(e,t="minilm",i=32){const n=[];for(let r=0;r<e.length;r+=i){const o=e.slice(r,r+i),m=await Promise.all(o.map(f=>this.generateEmbedding(f,t)));n.push(...m),r+i<e.length&&console.error(`Processed ${r+i}/${e.length} embeddings...`)}return n}cosineSimilarity(e,t){if(e.length!==t.length)throw new Error(`Embedding dimension mismatch: ${e.length} vs ${t.length}`);let i=0,n=0,r=0;for(let o=0;o<e.length;o++)i+=e[o]*t[o],n+=e[o]*e[o],r+=t[o]*t[o];return n===0||r===0?0:i/(Math.sqrt(n)*Math.sqrt(r))}async adaptiveRetrieval(e,t={},i="./.code-index-journal"){const r=e.split(/\s+/).length>10||e.includes("?")||t.previousQueries&&t.previousQueries.length>0?"gemma3n":"minilm";console.error(`Using ${c[r].name} for query: "${e.slice(0,50)}..."`);const o=await this.generateEmbedding(e,r);return this.searchCodeIndex(o,i,r)}async searchCodeIndex(e,t,i,n=5){try{return(await g.greptimeClient.searchTopK(e,n,2e3)).map(m=>({path:m.path,text:m.text,similarity:this.cosineSimilarity(e,m.embedding),sections:m.sections}))}catch(r){return console.error("GreptimeDB search error:",r),[]}}async saveEmbedding(e,t){const i=e.replace(/\.(md|ts|js)$/,".embedding");await h.writeFile(i,JSON.stringify(t,null,2),"utf8");try{const r={id:`${t.path}:${t.timestamp}`,path:t.path,text:t.text,embedding:t.embedding,sections:t.sections,timestamp:t.timestamp,modelId:t.modelId,dimension:t.dimension};await g.greptimeClient.upsertEmbedding(r)}catch(n){console.error("Failed to upsert embedding to GreptimeDB:",n)}}async loadEmbedding(e){const t=e.replace(/\.(md|ts|js)$/,".embedding");try{const i=await h.readFile(t,"utf8");return JSON.parse(i)}catch(i){if(i?.code==="ENOENT")return null;throw i}}getModelInfo(e){return c[e]}listModels(){return Object.values(c)}clearCache(){this.cache.clear(),console.error("Embedding cache cleared")}getCacheStats(){return{size:this.cache.size,keys:Array.from(this.cache.keys())}}}const d=a.getInstance();async function $(s,e="minilm"){return d.generateEmbedding(s,e)}async function C(s,e){return d.adaptiveRetrieval(s,e)}async function I(s,e="minilm"){const t=await d.generateEmbedding(s,e);return d.searchCodeIndex(t,"./.code-index-journal",e)}0&&(module.exports={MODELS,UnifiedEmbeddingService,adaptiveRetrieval,embeddingService,generateEmbedding,searchCodeWithEmbedding});
